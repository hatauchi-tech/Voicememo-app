# **要件定義書：音声文字起こし・ドキュメント連携 Webアプリケーション (Rev. 2.0)**

## **1\. 概要**

モバイルブラウザから音声を録音し、Gemini APIを用いて文字起こしを行った後、指定されたGoogleドキュメントに追記するGoogle Apps Script (GAS) スタンドアローンWebアプリケーション。生成されたテキストはNotebookLMのソースとして活用することを想定する。

## **2\. システム構成**

* **プラットフォーム:** Google Apps Script (Web Appとしてデプロイ)  
* **フロントエンド:** HTML5 / JavaScript (MediaRecorder API, Tailwind CSS)  
* **バックエンド:** Google Apps Script (.gs)  
* **AIモデル:** Google Gemini API  
  * デフォルト: gemini-3-flash-preview  
  * 構成により変更可能  
* **データストア:**  
  * **Google Docs:** 最終的な文字起こしテキストの出力先。  
  * **Google Drive:**  
    * 音声データの一時保存（チャンクファイル）。  
    * **非同期処理のキュー管理（タスク定義ファイル task.json の格納）**。  
    * ※処理完了後、フォルダごと物理削除を行う。  
* **設定管理:** Script Properties

## **3\. 機能要件**

### **3.1. ユーザーインターフェース (UI)**

* **デザイン:** スマートフォン（iOS/Android）およびPCでの操作に最適化されたレスポンシブデザイン。  
* **ドキュメント選択:** 録音開始前に、保存先のGoogleドキュメントをプルダウンリストから選択可能。  
  * データソース：スクリプトプロパティ (DOCUMENT\_n) で定義されたIDに基づく。  
* **録音機能:**  
  * 録音開始／停止ボタン。  
  * 録音時間タイマー表示。  
  * 録音中のビジュアルインジケータ（Pulse Animation）。  
* **非同期UIフィードバック:**  
  * 録音データ送信後、サーバー側の重い処理（AI推論・Docs書き込み）を待たずに「送信完了」を表示し、即座にUIを解放する。  
* **NotebookLM連携:** NotebookLMへの外部リンクボタンを配置。

### **3.2. 音声処理・文字起こし処理 (Backend)**

* **音声データ受信 (分割アップロード):**  
  * メモリ制限を回避するため、フロントエンドで音声をチャンク（例: 10MB単位）に分割し、順次送信する。  
  * サーバー側でDrive内の一時フォルダに保存する。  
* **非同期キュー管理 (Drive-based Queue):**  
  * アップロード完了時、セッションフォルダ内に task.json を生成し、これを処理待ちタスクとする。  
  * Script Propertiesによるキュー管理は行わない（ゴミデータ残留リスク回避のため）。  
* **Gemini API連携:**  
  * **Resumable Upload (再開可能なアップロード):** 大容量ファイルの転送信頼性を高めるため、マルチパートリクエストではなくResumable方式を採用。  
  * **Gemini File API:** 音声データを直接プロンプトに含めず、File API経由でURI参照させる。  
  * **プロンプト要件:**  
    * 「以下の音声を正確に文字起こししてください。」  
    * 「フィラー（『えー』『あのー』等）は完全に除外してください。」  
    * 「誤字脱字を修正したクリーンなテキストを出力してください。」  
* **実行制御・自動クリーンアップ:**  
  * **トリガー実行:** アップロード完了後、ScriptApp.newTrigger を動的に生成し、バックグラウンド処理を開始。  
  * **自己消滅:** 処理完了後、トリガー自分自身を削除する。  
  * **データ削除:** 処理完了後、Drive上の一時フォルダおよびGemini File API上のファイルを確実に削除する（finally ブロックによる保証）。

### **3.3. ドキュメント出力処理**

* **ヘッダー追加:** 選択されたドキュメントの末尾に「見出し3 (Heading 3)」を追加。  
  * フォーマット: 録音：yyyy/MM/dd/ HH:mm:ss  
* **本文追加:** 見出しの下に、Geminiが生成したテキストを標準テキストとして追記。

### **3.4. 設定管理 (Script Properties)**

以下のキーを用いて環境設定を行う。

| キー名称 | 値の形式 | 説明 |
| :---- | :---- | :---- |
| GEMINI\_API\_KEY | 文字列 | Google AI Studio発行のAPIキー |
| NOTEBOOK\_LM\_URL | URL | 遷移先のNotebookLM URL |
| TEMP\_FOLDER\_ID | ID文字列 | 一時ファイル保存用フォルダID (推奨) |
| DOCUMENT\_1, DOCUMENT\_2... | ID文字列 | 連携先ドキュメントID (連番) |
| GEMINI\_MODEL | 文字列 | (任意) 使用モデル名 (例: gemini-1.5-pro) |

## **4\. 非機能要件**

* **権限設定:**  
  * Execute as: **Me (Developer)**  
  * Who has access: **Anyone with Google Account** (またはドメイン内ユーザー)  
* **セキュリティ:**  
  * APIキーのサーバーサイド隠蔽。  
* **信頼性:**  
  * JSON.parse 等のエラーハンドリング強化。  
  * ゾンビタスク（実体のないキュー）の自動検知とスキップ機能。

## **5\. データフロー (改訂版)**

1. **\[User\]** Webアプリへアクセス & ドキュメント選択  
2. **\[User\]** 録音開始 \-\> 録音停止  
3. **\[Client\]** 音声Blobを分割(Chunking) \-\> uploadChunk で順次送信  
4. **\[Server\]** Drive内に session\_xxx フォルダを作成し、チャンクファイルを保存  
5. **\[Client\]** 全送信完了後、finalizeUpload をコール  
6. **\[Server\]** フォルダ内に task.json (タスク定義) を作成し、処理トリガーをセット。即座に **\[Client\]** へレスポンス（**UI解放**）  
7. **\[Async Trigger\]** (バックグラウンド処理)  
   * Driveをスキャンし、task.json を持つフォルダを特定  
   * task.json を processing.json にリネーム（ロック）  
   * チャンクを結合 \-\> **Gemini File API (Resumable)** へアップロード  
   * Gemini APIへ推論リクエスト  
   * 指定ドキュメントへ追記  
   * **クリーンアップ:** Geminiファイル削除、Driveフォルダ削除、トリガー削除